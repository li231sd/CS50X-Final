{% extends "layout.html" %}

{% block title %} My Events {% endblock %}

{% block main %}
  <h1 class="h1 mb-4 mt-5 text-center">My Events</h1>
  <div class="alert alert-info mb-4" role="alert">
    All info you entered in these events is final and may not change
  </div>

  <div class="row justify-content-center">
    <div class="col-lg-10">
      {% if events_hosted %}
        <div class="row row-cols-1 row-cols-md-2 g-4">
          {% for event in events_hosted %}
            <div class="col">
              <div class="card shadow-lg border-0 h-100 rounded-3">
                <div class="card-body">
                  <h4 class="card-title text-danger fw-bold mb-2">{{ event[16] }}</h4>
                  <p class="mb-1"><strong>Start Datetime:</strong> {{ event[13] }}</p>
                  <p class="mb-1"><strong>End Datetime:</strong> {{ event[14] }}</p>
                  <p class="mb-1"><strong>Location:</strong> {{ event[9] }}, {{ event[10] }}, {{ event[11] }}</p>
                  <p class="mb-1"><strong>Description:</strong> {{ event[17] }}</p>
                  <p class="mb-1"><strong>Spots Filled:</strong> TBA/{{ event[12] }}</p>
                </div>
                <div class="card-footer bg-white border-0 text-end">
                  <button 
                    class="btn btn-outline-danger btn-sm me-2" 
                    data-bs-toggle="modal" 
                    data-bs-target="#attendeesModal{{ event[0] }}">
                    Attendees
                  </button>
                  <button 
                    class="btn btn-danger btn-sm me-2" 
                    data-bs-toggle="modal" 
                    data-bs-target="#ConfirmModal{{ event[0] }}">
                    Cancel Event
                  </button>
                </div>
              </div>
            </div>
            
            <div class="modal fade" id="ConfirmModal{{ event[0] }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                  <div class="modal-content shadow-lg rounded-3 border-0">
                    <div class="modal-header bg-danger text-white">
                      <h5 class="modal-title">Confirm Deletion of {{ event[16] }}</h5>
                      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <p><strong>THIS ACTION IS IRREVERSIBLE.</strong> An email will be sent out to <strong>ALL</strong> attendees to this event regarding the deletion. Please confirm below.</p>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                      <button type="button" class="btn btn-success" onclick="del_event_secure('{{event[0]}}')">I Confirm</button>
                    </div>
                  </div>
                </div>
              </div>

            <!-- Modal -->
            <div class="modal fade" id="attendeesModal{{ event[0] }}" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content shadow-lg rounded-3 border-0">
                  <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Attendees for {{ event[16] }}</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    {% if events_attendees %}
                      <div class="table-responsive">
                        <table class="table table-borderless table-hover align-middle">
                          <thead class="table-light">
                            <tr>
                              <th scope="col">User ID</th>
                              <th scope="col">Name</th>
                              <th scope="col">Email</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% for attendee in events_attendees %}
                                {% if attendee[0] == event[0]%}
                                    <tr>
                                        <td>{{ attendee[1][0] }}</td>
                                        <td>{{ attendee[1][1] }}</td>
                                        <td>{{ attendee[1][2] }}</td>
                                    </tr>
                                {% endif %}
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                    {% else %}
                      <p class="text-muted">No attendees yet.</p>
                    {% endif %}
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                  </div>
                </div>
              </div>
            </div>
            <!-- End Modal -->
          {% endfor %}
        </div>
      {% else %}
        <div class="text-center">
          <p class="lead text-muted">You have not hosted any events yet.</p>
          <a href="/register-event" class="btn btn-danger">Host an Event</a>
        </div>
      {% endif %}
    </div>
  </div>
  <script>
    function del_event_secure(id) {
        fetch("/del_event_secure", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id: id }),
    }).then((response) => {
      if (response.ok) {
        alert("Successfully Deleted");
        window.location.href = "/";
      } else {
        alert("Something went wrong!");
        location.reload();
      }
    }); 
    }
  </script>
{% endblock %}
